name: CI

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "main" branch
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Check-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Set up JDK (required for Android builds)
      - name: Set up JDK 11
        uses: actions/setup-java@v2
        with:
          distribution: 'temurin'
          java-version: '11'

      # Set up Android SDK
      - name: Set up Android SDK
        uses: android-actions/setup-android@v2
        with:
          api-level: 33
          build-tools: "33.0.0"
          ndk: "22.1.7171670"

      # Run unit tests
      - name: Run Unit Tests
        run: ./gradlew test

      # Run instrumentation tests on an emulator
      - name: Start emulator
        uses: reactive circus/android-emulator-runner@v2
        with:
          api-level: 33
          target: default
          arch: x86_64
          profile: Nexus 6P
          emulator-options: "-no-snapshot-load -noaudio -no-boot-anim"
          disable-animations: true

      - name: Wait for emulator to boot
        run: adb wait-for-device

      - name: Run Android Instrumentation Tests
        run: ./gradlew connectedAndroidTest

      # Always stop emulator after tests
      - name: Stop Emulator
        if: always()
        run: adb -s emulator-5554 emu kill